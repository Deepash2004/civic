<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Public Grievance Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Source Sans Pro', sans-serif; background-color: #f8fafc; }
        .dashboard-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .spinner {
            border: 2px solid rgba(0,0,0,.1);
            border-left-color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex h-screen">

    <!-- Mock Backend & ML Simulation -->
    <script>
        (function() {
            // This is a self-invoking function to simulate a backend.
            // In a real application, this logic would live on a server.
            
            // --- FAKE DATABASE ---
            let issuesDB = [];

            // --- ML URGENCY MODEL SIMULATION ---
            function getUrgencyScore(issue) {
                let score = 2; // Base score
                const description = issue.description.toLowerCase();

                // Category-based scoring
                const categoryScores = {
                    'Traffic Accident': 5,
                    'Flooding': 4,
                    'Fallen Tree / Debris': 3,
                    'Pothole / Road Damage': 2,
                    'Streetlight Malfunction': 1
                };
                score += categoryScores[issue.category] || 0;

                // Keyword-based scoring from description
                const keywordScores = {
                    'injury': 5, 'injuries': 5, 'accident': 4, 'emergency': 5, 'fire': 5,
                    'blockage': 3, 'blocking': 3, 'major': 3, 'hazard': 4, 'dangerous': 4,
                    'power': 2, 'leak': 3, 'flooded': 4
                };

                for (const keyword in keywordScores) {
                    if (description.includes(keyword)) {
                        score += keywordScores[keyword];
                    }
                }
                
                // Cap the score at 10
                return Math.min(score, 10);
            }
            
            // --- MOCK DATA GENERATION ---
            function generateInitialData() {
                 const categories = ['Pothole / Road Damage', 'Streetlight Malfunction', 'Waste Management / Overflowing Bin', 'Damaged Sidewalk / Footpath', 'Fallen Tree / Debris', 'Traffic Accident', 'Flooding'];
                 const descriptions = {
                    'Traffic Accident': 'Major accident involving a bus and a car blocking the intersection. Multiple injuries reported.',
                    'Flooding': 'Main road completely flooded due to heavy rains. Water entering shops. It is a dangerous situation.',
                    'Fallen Tree / Debris': 'A large tree has fallen and is blocking the entire road near the park. A potential traffic hazard.',
                    'Pothole / Road Damage': 'There is a very large and dangerous pothole on the main road, causing issues for traffic.',
                    'Streetlight Malfunction': 'Streetlight has been out for a week, making the area dark and unsafe at night.',
                    'Waste Management / Overflowing Bin': 'The public trash bin is overflowing, causing a mess on the sidewalk.',
                    'Damaged Sidewalk / Footpath': 'The sidewalk is cracked and uneven, making it difficult for pedestrians.'
                 };

                if (issuesDB.length === 0) {
                    for (let i = 0; i < 25; i++) {
                        const category = categories[Math.floor(Math.random() * categories.length)];
                        const statusKeys = ['New', 'In Progress', 'Resolved'];
                        const status = i < 15 ? 'New' : (i < 22 ? 'In Progress' : 'Resolved');
                        const issue = {
                            id: (1000 + i).toString(),
                            category: category,
                            description: descriptions[category] || 'Standard report description.',
                            lat: 28.6139 + (Math.random() - 0.5) * 0.2,
                            lng: 77.2090 + (Math.random() - 0.5) * 0.2,
                            status: status,
                            photoUrl: `https://placehold.co/400x300/e2e8f0/334155?text=${category.substring(0,10)}`,
                            timestamp: new Date(Date.now() - Math.random() * 1000 * 60 * 60 * 24 * 14).toISOString()
                        };
                        issue.urgency = getUrgencyScore(issue);
                        issuesDB.push(issue);
                    }
                }
            }
            
            // --- SIMULATED API ROUTER ---
            const originalFetch = window.fetch;
            window.fetch = function(url, options) {
                const method = options?.method || 'GET';
                const body = options?.body ? JSON.parse(options.body) : null;
                
                if (url === '/api/issues') {
                    if (method === 'GET') {
                        return Promise.resolve(new Response(JSON.stringify(issuesDB), { status: 200, headers: { 'Content-Type': 'application/json' } }));
                    }
                    if (method === 'POST') {
                         const newIssue = {
                            id: (Date.now()).toString().slice(-6),
                            ...body,
                            status: 'New',
                            timestamp: new Date().toISOString()
                        };
                        newIssue.urgency = getUrgencyScore(newIssue);
                        issuesDB.push(newIssue);
                        return Promise.resolve(new Response(JSON.stringify(newIssue), { status: 201, headers: { 'Content-Type': 'application/json' } }));
                    }
                    if (method === 'PATCH') {
                        const issue = issuesDB.find(i => i.id === body.id);
                        if(issue) {
                            issue.status = body.status;
                            return Promise.resolve(new Response(JSON.stringify(issue), { status: 200, headers: { 'Content-Type': 'application/json' } }));
                        }
                        return Promise.resolve(new Response(null, { status: 404 }));
                    }
                }
                // If the URL is not our API, use the real fetch
                return originalFetch.apply(this, arguments);
            };

            generateInitialData();
        })();
    </script>

    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-gray-800 text-white flex flex-col">
        <div class="h-16 flex items-center justify-center text-xl font-bold border-b border-gray-700">
            MCD ADMIN PORTAL
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2">
            <a href="#" class="flex items-center px-4 py-2 bg-gray-900 rounded-md">
                <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                Dashboard
            </a>
            <a href="#" class="flex items-center px-4 py-2 hover:bg-gray-700 rounded-md">
                <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                Reports
            </a>
            <a href="#" class="flex items-center px-4 py-2 hover:bg-gray-700 rounded-md">
                 <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm-2 5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                Departments
            </a>
        </nav>
        <div class="p-4 border-t border-gray-700">
            <p class="text-sm">Logged in as: <span class="font-semibold">Admin User</span></p>
            <a href="#" class="text-sm text-indigo-400 hover:underline">Logout</a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 overflow-y-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Administrator Dashboard</h1>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="dashboard-card bg-white p-5 rounded-lg shadow">
                <h2 class="text-gray-500 text-sm font-medium">Total Reports</h2>
                <p id="stat-total" class="text-3xl font-bold text-gray-800">--</p>
            </div>
            <div class="dashboard-card bg-white p-5 rounded-lg shadow">
                <h2 class="text-gray-500 text-sm font-medium">New Reports (24h)</h2>
                <p id="stat-new-today" class="text-3xl font-bold text-indigo-600">--</p>
            </div>
            <div class="dashboard-card bg-white p-5 rounded-lg shadow">
                <h2 class="text-gray-500 text-sm font-medium">Resolution Rate</h2>
                <p id="stat-resolution-rate" class="text-3xl font-bold text-green-600">--%</p>
            </div>
            <div class="dashboard-card bg-white p-5 rounded-lg shadow">
                <h2 class="text-gray-500 text-sm font-medium">Avg. Resolution Time</h2>
                <p id="stat-avg-time" class="text-3xl font-bold text-amber-600">--</p>
            </div>
        </div>

        <!-- Map and Details View -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                 <h2 class="text-xl font-bold text-gray-800 mb-4">Urgency Hotspots</h2>
                <div id="map" class="h-96 w-full rounded"></div>
            </div>
            <div id="issue-details-panel" class="bg-white p-4 rounded-lg shadow hidden">
                 <h2 class="text-xl font-bold text-gray-800 mb-2">Issue Details</h2>
                 <p class="text-sm text-gray-500 mb-4">ID: <span id="details-id" class="font-mono"></span></p>
                 <img id="details-photo" src="" class="w-full h-40 object-cover rounded-md mb-4 bg-gray-200">
                 <p class="font-bold text-gray-700" id="details-category"></p>
                 <p class="text-sm text-gray-600 mb-3" id="details-location"></p>
                 <p class="text-sm bg-gray-50 p-2 rounded border" id="details-description"></p>

                 <div class="mt-4 border-t pt-4">
                    <button id="generate-briefing-btn" class="w-full flex items-center justify-center space-x-2 bg-gray-700 text-white py-2 rounded-md hover:bg-gray-800 mb-2 disabled:opacity-50">
                        <span>✨ Generate Safety Briefing</span>
                    </button>
                    <div id="briefing-container" class="hidden mt-2 p-3 bg-indigo-50 border border-indigo-200 rounded-md">
                        <h4 class="font-bold text-indigo-800 text-sm mb-1">AI Safety & Impact Briefing</h4>
                        <p id="briefing-text" class="text-sm text-indigo-700"></p>
                    </div>
                 </div>

                 <div class="mt-4 border-t pt-4">
                     <label for="status-update" class="block text-sm font-medium text-gray-700">Update Status</label>
                     <select id="status-update" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                         <option>New</option>
                         <option>In Progress</option>
                         <option>Resolved</option>
                     </select>
                     <button id="update-status-btn" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Update</button>
                 </div>
            </div>
        </div>
        
        <!-- Issues Table -->
        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Active Reports</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">ID</th>
                            <th scope="col" class="px-6 py-3">Urgency</th>
                            <th scope="col" class="px-6 py-3">Category</th>
                            <th scope="col" class="px-6 py-3">Date</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                        </tr>
                    </thead>
                    <tbody id="issues-table-body">
                        <!-- Rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        function AdminApp() {
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`;
            let allIssues = [];
            let map, infoWindow;
            let markers = {};
            let selectedIssueId = null;

            const DOMElements = {
                statTotal: document.getElementById('stat-total'),
                statNewToday: document.getElementById('stat-new-today'),
                statResolutionRate: document.getElementById('stat-resolution-rate'),
                statAvgTime: document.getElementById('stat-avg-time'),
                tableBody: document.getElementById('issues-table-body'),
                detailsPanel: document.getElementById('issue-details-panel'),
                detailsId: document.getElementById('details-id'),
                detailsPhoto: document.getElementById('details-photo'),
                detailsCategory: document.getElementById('details-category'),
                detailsLocation: document.getElementById('details-location'),
                detailsDescription: document.getElementById('details-description'),
                statusUpdateSelect: document.getElementById('status-update'),
                updateStatusBtn: document.getElementById('update-status-btn'),
                generateBriefingBtn: document.getElementById('generate-briefing-btn'),
                briefingContainer: document.getElementById('briefing-container'),
                briefingText: document.getElementById('briefing-text'),
            };
            
            async function generateSafetyBriefing() {
                if (!selectedIssueId) return;
                const issue = allIssues.find(i => i.id === selectedIssueId);
                if (!issue) return;

                const prompt = `Based on the following civic issue report, provide a 2-sentence safety and impact briefing for a municipal official in Delhi. Focus on potential dangers and urgency. Report Category: '${issue.category}'. Report Description: '${issue.description}'`;

                const btn = DOMElements.generateBriefingBtn;
                btn.disabled = true;
                btn.innerHTML = `<div class="spinner"></div><span>Generating Briefing...</span>`;
                DOMElements.briefingContainer.classList.add('hidden');

                try {
                    const apiKey = ""; // Leave empty
                    const response = await fetch(`${GEMINI_API_URL}${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    });

                    if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        DOMElements.briefingText.textContent = text;
                        DOMElements.briefingContainer.classList.remove('hidden');
                    } else {
                        throw new Error("No content in API response.");
                    }
                } catch (error) {
                    console.error("Gemini Safety Briefing Error:", error);
                    DOMElements.briefingText.textContent = "Could not generate AI briefing.";
                    DOMElements.briefingContainer.classList.remove('hidden');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span>✨ Regenerate Safety Briefing</span>';
                }
            }


            function initMap() {
                 map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: 28.6139, lng: 77.2090 }, zoom: 11,
                    styles: [{"featureType":"all","elementType":"geometry.fill","stylers":[{"weight":"2.00"}]},{"featureType":"all","elementType":"geometry.stroke","stylers":[{"color":"#9c9c9c"}]},{"featureType":"all","elementType":"labels.text","stylers":[{"visibility":"on"}]},{"featureType":"landscape","elementType":"geometry","stylers":[{"color":"#f5f5f5"}]},{"featureType":"landscape.man_made","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"poi","elementType":"geometry","stylers":[{"color":"#f5f5f5"}]},{"featureType":"road","elementType":"geometry","stylers":[{"color":"#ffffff"}]},{"featureType":"road.arterial","elementType":"labels.text.fill","stylers":[{"color":"#757575"}]},{"featureType":"road.highway","elementType":"geometry","stylers":[{"color":"#dadada"}]},{"featureType":"road.highway","elementType":"labels.text.fill","stylers":[{"color":"#616161"}]},{"featureType":"road.local","elementType":"labels.text.fill","stylers":[{"color":"#9e9e9e"}]},{"featureType":"transit","elementType":"geometry","stylers":[{"color":"#f5f5f5"}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#c9c9c9"}]}],
                    disableDefaultUI: true, zoomControl: true,
                });
                infoWindow = new google.maps.InfoWindow();
            }

            async function fetchData() {
                try {
                    const response = await fetch('/api/issues');
                    allIssues = await response.json();
                    renderDashboard();
                } catch (error) {
                    console.error("Error fetching data:", error);
                }
            }

            function renderDashboard() {
                updateStats();
                renderTable();
                renderMapMarkers();
            }

            function updateStats() {
                const total = allIssues.length;
                const newToday = allIssues.filter(i => (new Date() - new Date(i.timestamp)) < 86400000).length;
                const resolved = allIssues.filter(i => i.status === 'Resolved').length;
                DOMElements.statTotal.textContent = total;
                DOMElements.statNewToday.textContent = newToday;
                DOMElements.statResolutionRate.textContent = total > 0 ? `${Math.round((resolved/total)*100)}%` : '0%';
                DOMElements.statAvgTime.textContent = '3.2 Days'; // Mocked
            }

            function renderTable() {
                DOMElements.tableBody.innerHTML = '';
                const sortedIssues = [...allIssues].sort((a, b) => b.urgency - a.urgency);
                sortedIssues.forEach(issue => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50 cursor-pointer';
                    row.dataset.id = issue.id;
                    const urgencyColor = issue.urgency > 7 ? 'text-red-600' : issue.urgency > 4 ? 'text-amber-600' : 'text-green-600';
                    const statusColors = { New: 'bg-red-100 text-red-800', 'In Progress': 'bg-amber-100 text-amber-800', Resolved: 'bg-green-100 text-green-800' };
                    row.innerHTML = `
                        <td class="px-6 py-4 font-mono">${issue.id}</td>
                        <td class="px-6 py-4 font-bold ${urgencyColor}">${issue.urgency}/10</td>
                        <td class="px-6 py-4">${issue.category}</td>
                        <td class="px-6 py-4">${new Date(issue.timestamp).toLocaleDateString()}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[issue.status]}">${issue.status}</span></td>
                    `;
                    row.addEventListener('click', () => handleRowClick(issue.id));
                    DOMElements.tableBody.appendChild(row);
                });
            }

            function renderMapMarkers() {
                Object.values(markers).forEach(m => m.setMap(null));
                markers = {};
                allIssues.forEach(issue => {
                     const urgencyColors = { high: '#DC2626', medium: '#F59E0B', low: '#10B981' };
                     const color = issue.urgency > 7 ? urgencyColors.high : issue.urgency > 4 ? urgencyColors.medium : urgencyColors.low;
                     const marker = new google.maps.Marker({
                        position: { lat: issue.lat, lng: issue.lng }, map,
                        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 5 + issue.urgency / 2, fillColor: color, fillOpacity: 0.8, strokeColor: 'white', strokeWeight: 1.5 }
                     });
                     marker.addListener('click', () => handleRowClick(issue.id));
                     markers[issue.id] = marker;
                });
            }

            function handleRowClick(id) {
                selectedIssueId = id;
                const issue = allIssues.find(i => i.id === id);
                if (!issue) return;
                
                DOMElements.briefingContainer.classList.add('hidden');
                DOMElements.generateBriefingBtn.innerHTML = '<span>✨ Generate Safety Briefing</span>';

                // Update details panel
                DOMElements.detailsPanel.classList.remove('hidden');
                DOMElements.detailsId.textContent = issue.id;
                DOMElements.detailsPhoto.src = issue.photoUrl;
                DOMElements.detailsCategory.textContent = issue.category;
                DOMElements.detailsLocation.textContent = `Location: ${issue.lat.toFixed(4)}, ${issue.lng.toFixed(4)}`;
                DOMElements.detailsDescription.textContent = issue.description;
                DOMElements.statusUpdateSelect.value = issue.status;

                // Highlight table row
                document.querySelectorAll('#issues-table-body tr').forEach(row => {
                    row.classList.toggle('bg-indigo-100', row.dataset.id === id);
                });
                
                // Focus map
                map.panTo({ lat: issue.lat, lng: issue.lng });
                map.setZoom(15);
            }

            async function updateStatus() {
                if (!selectedIssueId) return;
                const newStatus = DOMElements.statusUpdateSelect.value;
                try {
                    const response = await fetch('/api/issues', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: selectedIssueId, status: newStatus }),
                    });
                    if (!response.ok) throw new Error('Update failed');
                    // Refresh data to reflect change
                    await fetchData();
                     DOMElements.detailsPanel.classList.add('hidden');
                } catch(error) {
                    console.error("Failed to update status:", error);
                }
            }
            
            this.start = function() {
                initMap();
                fetchData();
                DOMElements.updateStatusBtn.addEventListener('click', updateStatus);
                DOMElements.generateBriefingBtn.addEventListener('click', generateSafetyBriefing);
            }
        }

        function initAdminApp() {
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error("Google Maps API script failed to load. Please check your API key and network connection.");
                 document.getElementById('map').innerHTML = '<div class="h-full w-full bg-gray-200 flex items-center justify-center p-4 text-center"><p class="text-red-600 font-semibold">Map could not be loaded.<br>Please ensure you have replaced "YOUR_GOOGLE_MAPS_API_KEY" with a valid key in the script tag at the bottom of the HTML file.</p></div>';
                return;
            }
            const app = new AdminApp();
            app.start();
        }
    </script>
    <!-- 
    /**********************************************************************************************************/
    /* */
    /* IMPORTANT: You must replace "YOUR_GOOGLE_MAPS_API_KEY" with a valid Google Maps JavaScript API key.   */
    /* */
    /**********************************************************************************************************/
    -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkPlpH4yXoQGDVy3eOCu32hXcR86aVzEQ&callback=initAdminApp"></script>
</body>
</html>

